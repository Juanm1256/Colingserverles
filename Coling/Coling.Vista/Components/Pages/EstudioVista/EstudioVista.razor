@page "/estudios"

@inject IEstudioService servicio
@inject ITipoEstudioService serviciote
@inject IGradoAcademicoService serviciogra
@inject IInstitucionService servicioinsti
@inject IProfesionAfiliadoService servicioaf
@inject NavigationManager nav
@inject SweetAlertService sweetAlertService

@if (mostrarModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">@modalTitle</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <EditForm EditContext="contextoEdicionte" OnValidSubmit="GuardarCambios">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label>Tipo Estudio:</label>
                            <div>
                                <input type="text" class="form-control" @oninput="Filterte" placeholder="Buscar Tipo Estudio...">
                                <select class="form-control" @bind="@tiestudio.NombreTipo">
                                    @if (filteredte.Any())
                                    {
                                        <option value="0">Selecciona Tipo Estudio</option>
                                        foreach (var per in filteredte)
                                        {
                                            <option value="@per.NombreTipo">@($"{per.NombreTipo}")</option>
                                        }
                                    }
                                </select>
                                <ValidationMessage For="@(()=>tiestudio.NombreTipo)"></ValidationMessage>
                            </div>
                        </div>
                    </EditForm>
                    <EditForm EditContext="contextoEdiciongrado" OnValidSubmit="GuardarCambios">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label>Grado Academico:</label>
                            <div>
                                <input type="text" class="form-control" @oninput="Filtergrado" placeholder="Buscar Grado Academico...">
                                <select class="form-control" @bind="@selectedGradoNombre">
                                    @if (filteredgrado.Any())
                                    {
                                        <option value="0">Selecciona Grado Academico</option>
                                        @foreach (var gradoaca in filteredgrado)
                                        {
                                            <option value="@($"{gradoaca.NombreGrado}")">@($"{gradoaca.NombreGrado}")</option>
                                        }
                                    }
                                </select>
                                <ValidationMessage For="@(()=>afiliado.Id)"></ValidationMessage>
                            </div>
                        </div>
                    </EditForm>
                    <EditForm EditContext="contextoEdicioninstitucion" OnValidSubmit="GuardarCambios">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label>Institución:</label>
                            <div>
                                <input type="text" class="form-control" @oninput="Filterinstitucion" placeholder="Buscar Institución...">
                                <select class="form-control" @bind="@selectedInstitucionNombre">
                                    @if (filteredinstitucion.Any())
                                    {
                                        <option value="">Selecciona Afiliado</option>
                                        @foreach (var insti in filteredinstitucion)
                                        {
                                            <option value="@($"{insti.Nombre}")">@($"{insti.Nombre}")</option>
                                        }
                                    }
                                </select>
                                <ValidationMessage For="@(()=>afiliado.Id)"></ValidationMessage>
                            </div>
                        </div>
                    </EditForm>
                    <EditForm EditContext="contextoEdicionAfiliado" OnValidSubmit="GuardarCambios">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label>Nombre Afiliado:</label>
                            <div>
                                <input type="text" class="form-control" @oninput="FilterAfiliado" placeholder="Buscar afiliado...">
                                <select class="form-control" @bind="@selectedAfiliadoNombre">
                                    @if (filteredAfiliado.Any())
                                    {
                                        <option value="">Selecciona Afiliado</option>
                                        @foreach (var afiliado in filteredAfiliado)
                                        {
                                            <option value="@($"{afiliado.IdPersonanav.Nombre} {afiliado.IdPersonanav.Apellidos}")">@($"{afiliado.IdPersonanav.Nombre} {afiliado.IdPersonanav.Apellidos}")</option>
                                        }
                                    }
                                </select>
                                <ValidationMessage For="@(()=>afiliado.Id)"></ValidationMessage>
                            </div>
                        </div>
                    </EditForm>
                    <EditForm EditContext="contextoEdicion" OnValidSubmit="GuardarCambios">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label>Titulo Recibido:</label>
                            <div>
                                <InputText class="form-control" @bind-Value="@estudio.TituloRecibido"></InputText>
                                <ValidationMessage For="@(()=>estudio.TituloRecibido)"></ValidationMessage>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>Año:</label>
                            <div>
                                <InputText class="form-control" @bind-Value="@estudio.Anio"></InputText>
                                <ValidationMessage For="@(()=>estudio.Anio)"></ValidationMessage>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">@modalButtonLabel</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<h3>Listar Estudios</h3>

<div class="form-group row">
    <button type="button" class="btn btn-primary" @onclick="AbrirModalCrear">
        CREAR
    </button>
</div>

<div class="form-group row">
    <input class="form-control" @bind="@filtroNombre" @oninput="BuscarPorNombre" placeholder="Buscar por Nombre Afiliado" />
</div>

<div>
    <table class="table">
        <thead>
            <tr>
                <th><strong>Tipo</strong></th>
                <th><strong>Afiliado</strong></th>
                <th><strong>Grado</strong></th>
                <th><strong>Titulo Rebicido</strong></th>
                <th><strong>Institucion</strong></th>
                <th><strong>Año</strong></th>
                <th><strong>Estado</strong></th>
                <th><strong>Acciones</strong></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in EstudioListaPaginada)
            {
                <tr>
                    <td>@item.Tipo</td>
                    <td>@item.Afiliado</td>
                    <td>@item.Grado</td>
                    <td>@item.TituloRecibido</td>
                    <td>@item.Institucion</td>
                    <td>@item.Anio</td>
                    <td>@item.Estado</td>
                    <td>
                        @if (item.Estado == "Activo")
                        {
                            <button class="btn btn-primary m-1" @onclick="() => cambiarestado(item.RowKey, item.Estado)">Desactivar</button>
                            <button class="btn btn-primary m-1" @onclick="() => AbrirModalModificar(item.RowKey)">Editar</button>
                            <button class="btn btn-danger" @onclick="() => EliminarEstudio(item.RowKey)">Eliminar</button>
                        }
                        @if (item.Estado == "Inactivo")
                        {
                            <button class="btn btn-primary m-1" @onclick="() => cambiarestado(item.RowKey, item.Estado)">Activar</button>
                            <button class="btn btn-primary m-1" @onclick="() => AbrirModalModificar(item.RowKey)">Editar</button>
                            <button class="btn btn-danger" @onclick="() => EliminarEstudio(item.RowKey)">Eliminar</button>
                        }

                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
<div>
    <!-- Botones de paginación -->
    <button class="btn btn-primary" disabled="@EsPaginaInicial" @onclick="IrAPaginaAnterior">Anterior</button>
    <span>Página @paginaActual de @TotalPaginas</span>
    <button class="btn btn-primary" disabled="@EsPaginaFinal" @onclick="IrAPaginaSiguiente">Siguiente</button>
</div>

@code {

    private EditContext contextoEdicion;
    private EditContext contextoEdicionAfiliado;
    private EditContext contextoEdicionte;
    private EditContext contextoEdiciongrado;
    private EditContext contextoEdicioninstitucion;
    private string modalTitle = "Crear Estudio";
    private string modalButtonLabel = "Crear";
    private Estudio estudio = new Estudio();
    private Afiliado afiliado = new Afiliado();
    private TipoEstudio tiestudio = new TipoEstudio();
    private GradoAcademico grado = new GradoAcademico();
    private Institucion institucion = new Institucion();
    private bool mostrarModal = false;
    private string filtroNombre;
    private List<Estudio> EstudioListaPaginada { get; set; } = new List<Estudio>();
    private List<Afiliado> allAfiliado = new List<Afiliado>();
    private List<Afiliado> filteredAfiliado = new List<Afiliado>();
    private List<TipoEstudio> allte = new List<TipoEstudio>();
    private List<TipoEstudio> filteredte = new List<TipoEstudio>();
    private List<GradoAcademico> allgrado = new List<GradoAcademico>();
    private List<GradoAcademico> filteredgrado = new List<GradoAcademico>();
    private List<Institucion> allinstitucion = new List<Institucion>();
    private List<Institucion> filteredinstitucion = new List<Institucion>();
    private int paginaActual = 1;
    private int pageSize = 5;
    private string token="";
    private string selectedAfiliadoNombre;
    private string selectedGradoNombre;
    private string selectedInstitucionNombre;

    public List<Estudio> EstudioLista { get; set; } = new List<Estudio>();

    protected override async Task OnInitializedAsync()
    {
        string userd = await SecureStorage.GetAsync(nameof(Settings.detalleuser));
        if (!string.IsNullOrWhiteSpace(userd))
        {
            var userdt = JsonConvert.DeserializeObject<Detalleuser>(userd);

            var hadler = new JwtSecurityTokenHandler();
            var jsontoken = hadler.ReadToken(userdt.Token) as JwtSecurityToken;
            if (jsontoken.ValidTo < DateTime.UtcNow)
            {
                nav.NavigateTo("/login");
            }
            else
            {
                Settings.detalleuser = userdt;
                token = Settings.detalleuser.Token;
                contextoEdicion = new EditContext(estudio);
                contextoEdicionAfiliado = new EditContext(afiliado);
                contextoEdicionte = new EditContext(tiestudio);
                contextoEdiciongrado = new EditContext(grado);
                contextoEdicioninstitucion = new EditContext(institucion);
                await CargarEstudios();
                await CargarAfiliado();
                await Cargarte();
            }
        }
        else
        {
            nav.NavigateTo("/login");
        }
    }

    async Task CargarEstudios()
    {

        EstudioLista = await servicio.ListarEstado(token);
        await ActualizarListaPaginada();
        await CargarAfiliado();
        await Cargarte();
        await Cargargrado();
        await Cargarinstitucion();
    }

    private async Task ActualizarListaPaginada()
    {
        int inicio = (paginaActual - 1) * pageSize;
        int fin = inicio + pageSize;
        EstudioListaPaginada = EstudioLista.Skip(inicio).Take(pageSize).ToList();
    }

    private async Task IrAPaginaAnterior()
    {
        if (paginaActual > 1)
        {
            paginaActual--;
            await ActualizarListaPaginada();
        }
    }

    private async Task IrAPaginaSiguiente()
    {
        if (paginaActual < TotalPaginas)
        {
            paginaActual++;
            await ActualizarListaPaginada();
        }
    }


    private bool EsPaginaInicial => paginaActual == 1;
    private bool EsPaginaFinal => paginaActual == TotalPaginas;
    private int TotalPaginas => (int)Math.Ceiling((double)EstudioLista.Count / pageSize);
    private async Task GuardarCambios()
    {


        if (!string.IsNullOrEmpty(estudio.RowKey))
        {
            var result = await sweetAlertService.FireAsync(new SweetAlertOptions
                {
                    Title = "¿Estás seguro?",
                    Text = "¿Deseas modificar este registro de Estudio?",
                    Icon = SweetAlertIcon.Warning,
                    ShowCancelButton = true,
                    ConfirmButtonText = "Sí, Modificar",
                    CancelButtonText = "No, cancelar",
                });

            if (result.IsConfirmed)
            {
                var respuesta = await servicio.Modificar(estudio, token);
                if (!respuesta)
                {
                    await sweetAlertService.FireAsync("Error", "No se pudo modificar", SweetAlertIcon.Error);
                    return;
                }
                else
                {
                    await sweetAlertService.FireAsync("Modificado", "Se modifico correctamente", SweetAlertIcon.Success);
                }
            }
            CerrarModal();
            await CargarEstudios();
        }
        else
        {
            estudio.PartitionKey = "Educacion";
            estudio.Estado = "Activo";
            estudio.Tipo = tiestudio.NombreTipo;
            estudio.Afiliado = selectedAfiliadoNombre;
            estudio.Grado = selectedGradoNombre;
            estudio.Institucion = selectedInstitucionNombre;
            var respuesta = await servicio.Insertar(estudio, token);
            if (!respuesta)
            {
                await sweetAlertService.FireAsync("Error", "No se pudo guardar", SweetAlertIcon.Error);
                return;
            }
            else
            {
                await sweetAlertService.FireAsync("Guardado", "Se guardo correctamente", SweetAlertIcon.Success);
            }
        }
        if (!string.IsNullOrEmpty(filtroNombre))
        {
            EstudioLista = await servicio.ListarPorNombre(filtroNombre, token);
            CerrarModal();
            await ActualizarListaPaginada();
        }
        else
        {
            CerrarModal();
            await CargarEstudios();
        }
    }


    private async Task EliminarEstudio(string RK)
    {

        estudio = await servicio.ObtenerPorId(RK, token);
        var result = await sweetAlertService.FireAsync(new SweetAlertOptions
            {
                Title = "¿Estás seguro?",
                Text = "¿Deseas borrar este registro de Estudio?",
                Icon = SweetAlertIcon.Warning,
                ShowCancelButton = true,
                ConfirmButtonText = "Sí, borrarlo",
                CancelButtonText = "No, cancelar",
            });

        if (result.IsConfirmed)
        {
            estudio.Estado = "Eliminado";
            var respuesta = await servicio.Modificar(estudio, token);
            if (!respuesta)
            {
                await sweetAlertService.FireAsync("Error", "No se pudo eliminar", SweetAlertIcon.Error);
                return;
            }
            else
            {
                await sweetAlertService.FireAsync("Eliminado", "Se Elimino Correctamente", SweetAlertIcon.Success);
            }
        }
        if (!string.IsNullOrEmpty(filtroNombre))
        {
            EstudioLista = await servicio.ListarPorNombre(filtroNombre, token);
            await ActualizarListaPaginada();
        }
        else
        {
            await CargarEstudios();
        }
    }

    private void AbrirModalCrear()
    {
        estudio = new Estudio();
        contextoEdicion = new EditContext(estudio);
        tiestudio = new TipoEstudio();
        contextoEdicionte = new EditContext(tiestudio);
        afiliado = new Afiliado();
        contextoEdicionAfiliado = new EditContext(afiliado);
        grado = new GradoAcademico();
        contextoEdiciongrado = new EditContext(grado);
        institucion = new Institucion();
        contextoEdicioninstitucion = new EditContext(institucion);
        modalTitle = "Crear Estudio";
        modalButtonLabel = "Crear";
        selectedAfiliadoNombre = "";
        selectedInstitucionNombre = "";
        mostrarModal = true;
    }

    private async Task AbrirModalModificar(string rowKey)
    {
        
        estudio = await servicio.ObtenerPorId(rowKey, token);
        contextoEdicion = new EditContext(estudio);
        modalTitle = "Modificar Estudio";
        modalButtonLabel = "Guardar Cambios";
        mostrarModal = true;
    }

    private async Task cambiarestado(string rowKey, string estado)
    {
        
        if (estado == "Activo")
        {
            estudio = await servicio.ObtenerPorId(rowKey, token);

            var result = await sweetAlertService.FireAsync(new SweetAlertOptions
                {
                    Title = "¿Estás seguro?",
                    Text = "¿Deseas desactivar este registro de Estudio?",
                    Icon = SweetAlertIcon.Warning,
                    ShowCancelButton = true,
                    ConfirmButtonText = "Sí, Desactivar",
                    CancelButtonText = "No, cancelar",
                });

            if (result.IsConfirmed)
            {
                estudio.Estado = "Inactivo";
                var respuesta = await servicio.Modificar(estudio, token);
                if (!respuesta)
                {
                    await sweetAlertService.FireAsync("Error", "No se pudo desactivar", SweetAlertIcon.Error);
                    await CargarEstudios();
                }
                else
                {
                    await sweetAlertService.FireAsync("Desactivado", "Se Desactivo correctamente", SweetAlertIcon.Success);
                    await CargarEstudios();
                }

            }
        }
        else
        {
            estudio = await servicio.ObtenerPorId(rowKey, token);

            var result = await sweetAlertService.FireAsync(new SweetAlertOptions
                {
                    Title = "¿Estás seguro?",
                    Text = "¿Deseas Activar este registro de Estudio?",
                    Icon = SweetAlertIcon.Warning,
                    ShowCancelButton = true,
                    ConfirmButtonText = "Sí, Activar",
                    CancelButtonText = "No, cancelar",
                });

            if (result.IsConfirmed)
            {
                estudio.Estado = "Activo";
                var respuesta = await servicio.Modificar(estudio, token);
                if (!respuesta)
                {
                    await sweetAlertService.FireAsync("Error", "No se pudo activar", SweetAlertIcon.Error);
                }
                else
                {
                    await sweetAlertService.FireAsync("Activado", "Se Activo correctamente", SweetAlertIcon.Success);
                }
            }
        }
        if (!string.IsNullOrEmpty(filtroNombre))
        {
            EstudioLista = await servicio.ListarPorNombre(filtroNombre, token);
            await ActualizarListaPaginada();
        }
        else
        {
            await CargarEstudios();
        }
    }
    private async Task BuscarPorNombre(ChangeEventArgs e)
    {
        
        filtroNombre = e.Value.ToString();
        if (!string.IsNullOrEmpty(filtroNombre))
        {
            EstudioLista = await servicio.ListarPorNombre(filtroNombre, token);
            await ActualizarListaPaginada();
        }
        else
        {
            await CargarEstudios();
            await ActualizarListaPaginada();
        }

    }

    private void FilterAfiliado(ChangeEventArgs e)
    {
        string filter = e.Value.ToString().ToLower();
        filteredAfiliado = allAfiliado
            .Where(p => (p.IdPersonanav.Nombre + " " + p.IdPersonanav.Apellidos).ToLower().Contains(filter))
            .ToList();
    }

    private async Task CargarAfiliado()
    {
        allAfiliado = await servicioaf.ListarAfiliado(token);
        filteredAfiliado = allAfiliado.ToList();
    }

    private void Filterte(ChangeEventArgs e)
    {
        string filter = e.Value.ToString().ToLower();
        filteredte = allte
            .Where(p => (p.NombreTipo).ToLower().Contains(filter))
            .ToList();
    }

    private async Task Cargarte()
    {
        allte = await serviciote.ListarteEstadoActivo(token);
        filteredte = allte.ToList();
    }
    
    private void Filtergrado(ChangeEventArgs e)
    {
        string filter = e.Value.ToString().ToLower();
        filteredgrado = allgrado
            .Where(p => (p.NombreGrado).ToLower().Contains(filter))
            .ToList();
    }

    private async Task Cargargrado()
    {
        allgrado = await serviciogra.ListarGradoEstadoActivo(token);
        filteredgrado = allgrado.ToList();
    }
    
    private void Filterinstitucion(ChangeEventArgs e)
    {
        string filter = e.Value.ToString().ToLower();
        filteredinstitucion = allinstitucion
            .Where(p => (p.Nombre).ToLower().Contains(filter))
            .ToList();
    }

    private async Task Cargarinstitucion()
    {
        allinstitucion = await servicioinsti.ListarInstitucionEstadoActivo(token);
        filteredinstitucion = allinstitucion.ToList();
    }

    private void CerrarModal()
    {
        mostrarModal = false;
    }
}
